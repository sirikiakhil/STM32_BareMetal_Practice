/*
 * Sending Characters Using UART
 */
#include"stm32f4xx.h"

static void uart_config(void);
static void timer_config(void);
static void nvic_config(void);

int main(void)
{
	uart_config();
	while(1);
}

static void uart_config(void)
{
	//clock for UART2
	RCC->APB1ENR |= (1U << 13);
	(void)RCC->APB1ENR;

	USART2->CR1 &= ~(1U << 13);  //disabled uart to configure
	USART2->CR1 |= (1U << 6);     //Enabling the interrput when transmission complete

	USART2->BRR = 833.3125;      //configuring Buadrate

	USART2->CR1 |= (1U <<13);    //Enable the UART2
}

static void timer_config(void)
{
	//  is on AHB1 bus
	RCC->APB1ENR |=RCC_APB1ENR_TIM2EN ;      //Enableing the clock for TIMER2
	(void)RCC->APB1ENR;                       // read-back to ensure clock is active

	TIM2->CR1 &= ~(TIM_CR1_CEN);               //Disableing the TIM2

	TIM2->PSC = 15999;                       //setting prescaler value (for 16MHz clk freq) , at this value the tick period 1000Hz (1msec)
	TIM2->ARR = 1000;                        //setting ARR to 1000 (0-1000) , at this value the overflow time 1000 x 1mHz = 1sec

	TIM2->SR &= ~TIM_SR_UIF;                       //clearing UIF flag

	TIM2->CR1 |= TIM_CR1_CEN;               //Enableing the TIM2
}
static void nvic_config(void)
{
	NVIC->ISER[0] |= (1U << 28);              //setting the ISER register 28th position or 28th interrupt (TIM2 Interrupt)

	NVIC->IP[28] &= ~(16U << 4);             //clearing the IPR[28] register of offset 0
	NVIC->IP[28] |= (1 << 4);              //setting the IPR[28] register of offset 0
}

void TIM2_IRQHandler(void)
{
	TIM2->SR &= ~(TIM_SR_UIF);                       //clearing UIF flag (without touching other bits)
	if(USART2->SR & (1U << 7))
	{
	   USART2->DR = 101;
	   if(!(USART2->CR1 & (1U << 2) ))
	   {
		   USART2->CR1 |= (1U << 3);
	   }
	}
}
