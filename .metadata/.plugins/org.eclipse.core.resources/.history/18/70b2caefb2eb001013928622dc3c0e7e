
#include "SPI.h"

static void led_config(void);

int main(void)
{
	spi1_gpio_config();
	spi2_gpio_config();

	spi1_config();
	spi2_config();

	led_config();

	uint8_t spi1_tx_data[3]= {0x77, 0x88, 0x99};  //0x88 -> because we took 8 bits (1000 1000) ,for 0x99 (1001 1001)
	uint8_t spi2_rx_data[3];
	uint8_t spi1_rx_data[3];

	cs_enable();

	for(uint8_t i=0; i<3; i++)
	{
		while(!(SPI1->SR & SPI_SR_TXE)){}

		SPI1->DR = spi1_tx_data[i];

		while(!(SPI2->SR & SPI_SR_RXNE)){}

		spi2_rx_data[i] = SPI2->DR;

		while(!(SPI1->SR & SPI_SR_RXNE)){}

		spi1_rx_data[i] = SPI1->DR;

	}

	while(SPI1->SR & SPI_SR_BSY){}

	while(1)
	{
		for(uint8_t i =0; i<3; i++)
		{
			if(spi1_tx_data[i] == spi2_rx_data[i])
			{
				GPIOA->ODR |= (1U << 9);
				for(uint32_t j=0; j<200000; j++);
			}
		}

		for(uint32_t i=0; i<2000000; i++);
	}
}


static void led_config(void)
{
	GPIOA->MODER &= ~(3U << 18);
	GPIOA->MODER |=  (1U << 18);
}
